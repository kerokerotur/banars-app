このリポジトリでは、エージェントは常に日本語で返答してください。

ドキュメント種別:
- この AGENTS.md は AI 向けの運用ルール集。README.md は人間読者向けなので、案内や解説は README.md に記載すること。
- ルート README など上位階層のドキュメントは、下位ドキュメント（各ディレクトリの README 等）の参照と概要記載のみに留め、詳細なルールや手順は必ず下位ドキュメントの責務とすること。この方針を変更・追加する際は該当 README とセットで反映する。
- 実装や開発タスクを行う際は、必ず最新の DESIGN_DOCS（`docs/DESIGN_DOCS/`）をインプットとして参照し、記載内容に沿って作業すること。DESIGN_DOCS と異なる意図が疑われる場合は着手前に確認する。
- コーディング・実装時は PRD と DESIGN_DOCS を読み込み、仕様と意図を十分に理解した上で記載された内容に忠実に実装すること。疑義や不足があれば着手前に必ずユーザーへ確認する。

開発環境・コマンド運用:
- Flutter 関連の CLI コマンドを実行する際は、必ず FVM を用いて `fvm flutter <command>` の形式で実行し、直接 `flutter` を呼び出さないこと。
- core/domain/ 配下のクラス（entity、value_objects、service）には必ずユニットテストを実装する。詳細は `backend/README.md` の「ドメイン層のテストルール」を参照。
- 値オブジェクト（Value Object）を新規作成する際は、必ず `backend/core/shared/value_objects/value_object.ts` の基底クラス `ValueObject<T>` を継承すること。これにより等価性判定（`equals` メソッド）が統一される。
- Supabase Edge Functions を新規作成する際は、必ず `supabase functions new <function名>` を先に実行すること。CLI が `functions/` ディレクトリと `config.toml` への設定を自動生成するため、手動でファイルを作成しない。生成後に `make bundle-functions` を実行すると、`index.ts` が `src/index.ts` に自動移動され、`config.toml` の `entrypoint` も自動修正される。その後 `src/index.ts` と `deno.json` を編集して実装を行う。
- Edge Functions のデプロイ時は必ず `make deploy-functions` を使用すること。このコマンドはバンドル（`backend/` 配下のコードを含める）と config.toml の更新を自動で行ってからデプロイする。`supabase functions deploy` を直接実行しないこと。
- Edge Functions の依存関係は **ハイブリッド構成** で管理する:
  - `infra/supabase/functions/deno.json` に全関数共通の依存（Hono、Zod、Supabase等）を定義する。
  - `infra/supabase/functions/<function名>/deno.json` に関数固有の依存を追記する（Supabase CLI が空のimportsで生成）。
  - Denoは両方の設定を自動的にマージするため、共通依存は一箇所で管理できる。
  - 新しい依存を追加する場合、全関数で使うなら親の `deno.json`、特定関数でのみ使うなら個別の `deno.json` に追記すること。
  - 詳細は `infra/supabase/README.md` の「Edge Functions 依存関係管理」セクションを参照。
- ローカル開発用の初期データ（テストユーザー、サンプルデータ等）は `infra/supabase/seed.sql` に集約する:
  - `supabase db reset` 実行時にマイグレーション適用後に自動実行される。
  - `supabase db push` では実行されないため、本番環境には影響しない。
  - manager ロールを持つテストユーザーなど、動作確認に必要なデータを定義する。
  - 新しい初期データが必要な場合は、このファイルに追記すること。
- テーブル間の外部キー制約（FOREIGN KEY / REFERENCES）は原則として設定しない:
  - 本アプリは簡易的なアプリであり、レコード間の厳密な整合性よりも、柔軟にデータの変更ができるメリットを優先する。
  - 参照整合性が必要な場合はアプリケーション層で担保する。
  - 詳細は `docs/DESIGN_DOCS/README.md` の「データモデル運用ルール」を参照。
- 既存のマイグレーションファイルは絶対に修正しない:
  - Supabase はリモート環境で適用済みのマイグレーションをファイル名で管理しているため、適用済みファイルを修正しても変更は反映されない。
  - スキーマを変更したい場合は、必ず新しいマイグレーションファイルを作成して `ALTER TABLE` 等で修正すること。
  - 詳細は `infra/supabase/README.md` の「マイグレーション作成・命名規則」を参照。

PRD を扱う際の手順（AI 用）:
- PRD の更新前に、背景/目的、ステークホルダー、要件（機能・体験）の 3 章に情報が揃っているか確認する。小規模アプリのため、章 4〜7 は追加しない。
- 各決定事項には、なぜその選択になったかの理由を必ず添える。理由は運営課題や UX の観点にひも付ける。
- DESIGN_DOCS との責務分担を維持する。PRD では要求と意図のみを書き、実装手段は DESIGN_DOCS へ委ねる。
- 変更が必要な場合は、ユーザーへ質問を投げかけるなど対話的に要件を確認してから PRD を修正する。単独判断で更新しない。

DESIGN_DOCS の管理方針（AI 用）:
- `docs/DESIGN_DOCS/overview.md` に全体アーキテクチャとコンテキスト一覧を集約する。各コンテキストのサマリとリンクを必ず更新する。
- コンテキストごとにサブディレクトリを作成する（例: `docs/DESIGN_DOCS/events/`, `docs/DESIGN_DOCS/attendance/`, `docs/DESIGN_DOCS/auth/`）。ディレクトリ名は英小文字スネークケースで統一。
- 各コンテキスト配下では、単一機能単位の Markdown を置く。必要なら `index.md` を置いて目次やローカルルールを記載する。
- 設計内容には PRD と同様に意思決定の理由を添える。実装詳細・依存サービス・権限設計を明記し、変更時は関連ファイルと overview のリンクをセットで更新する。
- DESIGN_DOCS を修正する際も、ユーザーと対話しながら内容の確認・合意を得てから編集する。独断で加筆・削除を行わない。
- 個別機能の詳細設計（フロー、データモデル、入力項目など）を記述する前に必ずユーザーへ案や選択肢を提示し、OK を得てから文書化する。承認前は推測で仕様を固定せず、質問や未決定事項として明示する。
- DESIGN_DOCS 配下の README (`docs/DESIGN_DOCS/README.md`) で案内しているディレクトリ表と導線に更新漏れがないかを必ず確認し、差分がある場合は README も同時に更新する。
- overview のドメインコンテキスト表ではディレクトリとコンテキスト名のみを管理し、機能一覧や詳細リンクは `docs/DESIGN_DOCS/README.md` に集約する。
- テーブル定義は必ずコンテキスト単位（例: `docs/DESIGN_DOCS/auth/tables.md` / `events/tables.md`）で管理し、機能ドキュメントや README に散在させない。複数機能で共用するテーブルは該当コンテキストの `tables.md` に集約し、各機能ドキュメントから参照リンクを貼る。
- データモデルの命名規則や運用ルールなど、コンテキスト共通の方針は `docs/DESIGN_DOCS/README.md` にまとめ、各 `tables.md` ではテーブル個別仕様に集中する。
- DESIGN_DOCS の各機能ドキュメントは `docs/DESIGN_DOCS/template_feature.md` の章立て（シーケンス図→データ/API→権限・セキュリティ→エラー/フォールバック→未決定事項）と記述形式（API 入出力を JSON ブロック＋見出し付き）に揃える。既存ファイルを修正する場合もテンプレートに準拠させる。
- 今後、ドキュメント運用や修正方針に関する新たな決定が発生した場合は、例外なく本 AGENTS.md に追記して記録し、次回以降のチャットセッションでも同じ観点が参照できるようにする。

値オブジェクト／エンティティ運用方針:
- 実装ロジックは可能な限り値オブジェクトまたはエンティティに持たせ、ドメインサービスは最小限にする。特に正規化やバリデーションなど、値自身に閉じる処理は値オブジェクトに実装すること。

未確定事項の扱い:
- 実装やドキュメント修正の際に要件が不明確な場合、推測や仮定で進めず、必ずユーザーへ確認質問を行ってから作業を継続すること。
